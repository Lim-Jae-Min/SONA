<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<mapper namespace="com.sona.music.mypage.dao.MyPageDAO">

<select id="getUserInfo" parameterType="String" resultType="com.sona.music.mypage.dto.MyPageDTO">
    SELECT 
        u.user_name,
        u.user_type,
        u.user_id,
        u.user_email,
        u.user_phone,
        u.user_bank,
        u.user_accountnumber,
        af.applyform_inst,
        af.applyform_location,
        af.applyform_days,
        af.applyform_style,
        af.have_inst,
        (SELECT pb.NEW_FILENAME FROM PHOTO_BOARD pb WHERE u.USER_ID = pb.USER_ID
        		 AND pb.PHOTO_CATEGORY='Profile' and pb.USER_ID=#{loginId}) as profile
    FROM USERS u
    LEFT JOIN APPLICATION_FORM af ON u.user_id = af.user_id AND af.user_id = #{loginId}
    WHERE u.user_id = #{loginId}
</select>
    
    
    
    
    <update id="updateUserInfo" parameterType="map">
        UPDATE USERS u
        INNER JOIN APPLICATION_FORM us ON u.user_id = us.user_id
        SET 
            u.user_name = #{user_name},
            u.user_pass = #{user_pass},
            u.user_email = #{user_email},
            u.user_phone = #{user_phone},
            u.user_accountnumber = #{user_accountnumber},
            u.user_bank = #{user_bank},
            us.inst_category_idx = #{instCategory},
            us.applyform_inst = #{applyform_inst},
            us.applyform_location = #{applyform_location},
            us.applyform_days = #{applyform_days},
            us.applyform_style = #{applyform_style}
        WHERE u.user_id = #{loginId}
    </update>
    
		<select id="getClassNames" parameterType="String" resultType="String">
		    SELECT DISTINCT co.class_name
		    FROM CLASS_QUESTION cq
		    JOIN CLASS_OPEN co ON cq.class_idx = co.class_idx
		    WHERE cq.user_id = #{param1}
		</select>
		
	    
		
		<select id="qnaList" resultType="com.sona.music.mypage.dto.MyPageDTO" parameterType="java.util.Map">
		    SELECT 
		        cq.anonymous_status,
		        cq.q_title,
		        CASE WHEN cq.question_idx = ca.answer_idx THEN 'Y' ELSE 'N' END AS answer_status,
		        cq.q_reg_date,
		        co.class_name
		    FROM 
		        CLASS_QUESTION cq
		    LEFT JOIN 
		        CLASS_ANSWER ca ON cq.question_idx = ca.answer_idx
		    JOIN 
		        CLASS_OPEN co ON cq.class_idx = co.class_idx
		    WHERE
		        cq.user_id = #{param3}
		    ORDER BY
		        cq.question_idx DESC
		    LIMIT #{param2},#{param1}
		</select>
		
		
		<select id="allCount" resultType="Integer" parameterType="Integer">
    		SELECT CEIL(COUNT(*) / #{pagePerCnt}) AS pages FROM CLASS_QUESTION
		</select>
		
		<select id="pointList" resultType="com.sona.music.mypage.dto.MyPageDTO" parameterType="java.util.Map">
		SELECT 
		    up.point_date,
		    up.point_type,
		    up.point,
		    (SUM(point) OVER (ORDER BY up.point_idx)) AS balance
		FROM 
		    USER_POINT up 
		WHERE 
		    up.user_id = #{param3}
		ORDER BY 
		    up.point_idx desc
		LIMIT #{param2},#{param1}
		    
	   </select>
	   
	   <select id="getPointAmount" parameterType="String" resultType="com.sona.music.mypage.dto.MyPageDTO">
		    SELECT SUM(point)
		    FROM USER_POINT
		    WHERE user_id = #{loginId}
		</select>
		
		
		
		<select id="lessonlist" resultType="com.sona.music.member.dto.MemberDTO">
		SELECT co.class_name
		   , CASE WHEN (SELECT COUNT(apply_state) FROM APPLY_HISTORY ah WHERE ah.apply_state = '결제 완료' AND ah.class_idx = co.class_idx) IS NULL
		         THEN 0
		         ELSE (SELECT COUNT(apply_state) FROM APPLY_HISTORY ah WHERE ah.apply_state = '결제 완료' AND ah.class_idx = co.class_idx)
		         END AS count
		   , FORMAT((SELECT avg(r.score) FROM REVIEW r WHERE co.class_idx = '2'), 1) AS score
		   , co.class_reg_date
		FROM CLASS_OPEN co WHERE co.USER_ID = 'user2'
		ORDER BY co.CLASS_IDX desc
		LIMIT #{param2} OFFSET #{param3}
	</select>
		
	    
	    
	<select id="favoriteListCall" resultType="com.sona.music.mypage.dto.MyPageDTO">
		<![CDATA[
			SELECT
				mt.teacher_id AS user_id
				, u.user_name
				, (SELECT pb.new_filename FROM PHOTO_BOARD pb WHERE pb.user_id = mt.teacher_id AND pb.photo_category = 'Profile') AS new_filename
				, CASE WHEN (SELECT COUNT(co.class_idx) FROM CLASS_OPEN co WHERE co.user_id = mt.teacher_id) IS NULL
					THEN 0
					ELSE (SELECT COUNT(co.class_idx) FROM CLASS_OPEN co WHERE co.user_id = mt.teacher_id)
					END AS accumulate_lesson
				, CASE WHEN (SELECT COUNT(mh.manner_idx) FROM MANNER_HISTORY mh WHERE mh.user_id = mt.teacher_id) < 5
					THEN '신규 강사'
					ELSE CONCAT(FORMAT((SELECT (SUM(mh.manner_variance) + 36.5) FROM MANNER_HISTORY mh WHERE mh.user_id = mt.teacher_id), 2), '')
					END AS manner
			FROM MY_TEACHER mt JOIN USERS u ON mt.teacher_id = u.user_id
			WHERE mt.user_id = #{param3} AND mt.category = 'favorite'
			LIMIT #{param1} OFFSET #{param2}
		]]>
	</select>
	
	<select id="favoriteListCount" resultType="Integer">
		SELECT CEIL(COUNT(user_id)/#{param1}) FROM MY_TEACHER WHERE user_id = #{param2} AND category = 'favorite'
	</select>
	
	<delete id="teacherListDel">
		DELETE FROM MY_TEACHER WHERE teacher_id = #{param1} AND user_id = #{param2}
	</delete>
	    
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<mapper namespace="com.sona.music.board.dao.ReviewDAO">

	<select id="list" resultType="com.sona.music.board.dto.ReviewDTO">
		SELECT
		r.REVIEW_IDX,
    	r.SCORE, 
    	r.REVIEW_TITLE, 
    	r.RATER_ID, 
   		 CONCAT(MIN(CH_DATE), ' ~ ', MAX(CH_DATE)) AS STUDY_DATE,
   		(SELECT COUNT(NEW_FILENAME) FROM PHOTO_BOARD p WHERE p.POST_IDX = r.REVIEW_IDX) AS img_cnt,
    	r.REVIEW_REG_DATE 
		FROM REVIEW r 
		JOIN CLASS_HISTORY ch ON r.CLASS_IDX = ch.CLASS_IDX
		WHERE r.REVIEW_DELETE = 0
		GROUP BY r.REVIEW_IDX
		ORDER BY REVIEW_IDX DESC 
		LIMIT #{param1} OFFSET #{param2};
	</select>
	
	<select id="allCount" resultType="Integer">
		SELECT CEIL(COUNT(REVIEW_IDX)/#{param1}) AS pages FROM REVIEW
	</select>
	
	<insert id="write"
	useGeneratedKeys="true"
	keyColumn = "REVIEW_IDX"
	keyProperty="REVIEW_IDX"
	parameterType="com.sona.music.board.dto.ReviewDTO"
	>
	INSERT INTO REVIEW(CLASS_IDX,RATER_ID,RATEE_ID,SCORE,REVIEW_TITLE,REVIEW_CONTENT)
			VALUES(#{CLASS_IDX},#{RATER_ID},#{RATEE_ID},#{SCORE},#{REVIEW_TITLE},#{REVIEW_CONTENT})
	
	</insert>
	
	<insert id="fileWrite">
		INSERT INTO PHOTO_BOARD(ORI_FILENAME,NEW_FILENAME,POST_IDX,USER_ID,PHOTO_CATEGORY)
			VALUES(#{param1},#{param2},#{param3},#{param4},#{param5})
	</insert>
	
	<select id="detail" resultType="com.sona.music.board.dto.ReviewDTO">
		select * from REVIEW where REVIEW_IDX = #{param1}
	</select>
	
	<select id="photos" resultType="com.sona.music.board.dto.PhotoDTO">
		SELECT ORI_FILENAME, NEW_FILENAME, POST_IDX,PHOTO_CATEGORY
		FROM PHOTO_BOARD WHERE POST_IDX = #{param1} AND PHOTO_CATEGORY = #{param2}
	</select>
	
	<select id="deleteReview" resultType="com.sona.music.board.dto.ReviewDTO">
		UPDATE REVIEW
		SET REVIEW_DELETE = 1
		WHERE REVIEW_IDX = #{param1}
	</select>
	
	<update id="update" parameterType="map">
		UPDATE REVIEW SET  
		REVIEW_TITLE =#{REVIEW_TITLE} , 
		REVIEW_CONTENT =#{REVIEW_CONTENT} 
		WHERE REVIEW_IDX = #{REVIEW_IDX}
	</update>
	
	<delete id="photoEdit" parameterType="com.sona.music.board.dto.PhotoDTO">
    DELETE FROM PHOTO_BOARD WHERE POST_IDX = #{param1} AND PHOTO_CATEGORY = #{param2}
	</delete>

</mapper>